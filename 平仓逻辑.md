我来帮你查看当前目录下的代码，分析平仓逻辑并梳理出来。让我先读取相关的Python文件来了解平仓逻辑。

[6 tools called]

通过分析你的代码，我发现了这些交易脚本的平仓逻辑确实基本一致。让我为你梳理出完整的平仓逻辑框架：

[3 tools called]

## 平仓逻辑分析总结

经过对所有交易脚本的分析，我发现平仓逻辑确实基本一致，以下是详细梳理：

### 🎯 **核心平仓逻辑架构**

所有脚本都遵循相同的**分档移动止盈 + 固定止损**策略：

#### **1. 档位分级系统**
- **无档位**：初始状态，只有固定止损保护
- **低档保护止盈**：达到 `low_trail_profit_threshold` 后激活
- **第一档移动止盈**：达到 `first_trail_profit_threshold` 后激活  
- **第二档移动止盈**：达到 `second_trail_profit_threshold` 后激活

#### **2. 止盈触发条件**
```
低档保护止盈：profit_pct <= low_trail_stop_loss_pct
第一档移动止盈：profit_pct <= highest_profit × (1 - trail_stop_loss_pct)  
第二档移动止盈：profit_pct <= highest_profit × (1 - higher_trail_stop_loss_pct)
固定止损：profit_pct <= -stop_loss_pct
```

#### **3. 持仓监控机制**
- **首次检测**：初始化最高盈利值和档位状态
- **加仓检测**：重置最高盈利和档位，重新开始计算
- **手动平仓检测**：自动清理已平仓的监控数据

### 📊 **各平台差异对比**

| 特性 | Bitget | Binance | OKX | OKX Bot | OKX All |
|------|--------|---------|-----|---------|---------|
| **平仓方式** | API专用接口 | 市价单 | 专用平仓接口 | 信号策略平仓 | 批量全平仓 |
| **持仓模式** | 强制双向持仓 | 默认期货模式 | 自动检测模式 | 标准模式 | 自动检测模式 |
| **监控粒度** | 单个持仓 | 单个持仓 | 单个持仓 | 单个持仓 | **总体盈利** |
| **特殊功能** | 持仓模式检查 | 简化实现 | 持仓模式适配 | 信号策略集成 | 全局止损 |

### 🔧 **实现细节差异**

#### **平仓接口调用**
```python
# Bitget - 使用专用批量平仓接口
self.exchange.privateMixPostV2MixOrderClosePositions({
    'symbol': bg_symbol, 
    'holdSide': side, 
    'productType': 'USDT-FUTURES'
})

# Binance - 使用标准市价单
self.exchange.create_order(symbol, 'market', side, amount, None, {'type': 'future'})

# OKX - 使用第三方库平仓接口  
self.trading_bot.close_positions(instId=market_symbol, mgnMode=td_mode, posSide=pos_side)

# OKX Bot - 信号策略专用平仓
self.trading_bot.signal_close_position(instId=market_symbol, algoId=algo_id)
```

#### **持仓数据获取**
- **标准模式**：`exchange.fetch_positions()` 
- **OKX Bot模式**：通过信号策略API获取持仓
- **OKX All模式**：计算所有持仓的平均盈利

### 🎨 **统一的状态管理**

所有脚本都维护三个核心状态字典：
```python
self.highest_profits = {}      # 记录每个品种的最高盈利
self.current_tiers = {}        # 记录每个品种的当前档位  
self.detected_positions = {}   # 记录检测到的持仓信息
```

### 📈 **配置参数统一性**

所有脚本使用相同的配置参数结构：
- `stop_loss_pct` - 固定止损百分比
- `low_trail_stop_loss_pct` - 低档保护止盈百分比
- `trail_stop_loss_pct` - 第一档移动止盈回撤比例
- `higher_trail_stop_loss_pct` - 第二档移动止盈回撤比例
- `low_trail_profit_threshold` - 低档保护激活阈值
- `first_trail_profit_threshold` - 第一档移动止盈激活阈值  
- `second_trail_profit_threshold` - 第二档移动止盈激活阈值

[1 tool called]

### 🎯 **总结**

你的代码确实实现了**统一的平仓逻辑架构**：

1. **核心算法一致**：都采用分档移动止盈策略
2. **参数配置统一**：使用相同的配置参数结构  
3. **状态管理相同**：维护相同的监控状态数据
4. **流程逻辑相同**：遵循相同的决策流程

**主要差异**仅在于：
- 不同交易所的API调用方式
- 特定平台的功能适配（如信号策略、批量操作）
- 持仓数据的获取和处理方式

这种设计很好地实现了**策略逻辑与平台实现的分离**，便于维护和扩展到新的交易平台。